<!DOCTYPE html>
<html lang="de">
    <head>
        <meta charset="utf-8" />
        <meta name="viewport" content="width=device-width,initial-scale=1" />
        <title>AI Image Agent — Dark UI</title>
        <script src="https://cdn.tailwindcss.com"></script>
        <link rel="stylesheet" href="/styles/output.css" />
        <style>
            :root {
                color-scheme: dark;
            }
            .spinner {
                border: 4px solid rgba(255, 255, 255, 0.3);
                border-radius: 50%;
                border-top: 4px solid #fff;
                width: 40px;
                height: 40px;
                animation: spin 1s linear infinite;
                margin: auto; /* Zentriert ihn */
            }
            @keyframes spin {
                0% {
                    transform: rotate(0deg);
                }
                100% {
                    transform: rotate(360deg);
                }
            }
        </style>
    </head>
    <body class="bg-gray-900 text-gray-100 min-h-screen">
        <div class="max-w-3xl mx-auto p-6">
            <h1 class="text-3xl font-bold mb-2">AI Image Agent</h1>
            <p class="text-gray-400 mb-6">
                Gib ein Thema ein, wähle Stile und klicke <strong>Generate Images</strong>.
            </p>

            <label class="block mb-2 font-semibold">Thema / Nachricht</label>
            <textarea
                id="prompt"
                class="w-full p-3 rounded bg-gray-800 border border-gray-700"
                rows="3"
                placeholder="z. B. spider man vs venom"></textarea>

            <label class="block mt-4 mb-2 font-semibold">KI-Engine</label>
            <div class="flex gap-4 mb-4">
                <label class="inline-flex items-center gap-2">
                    <input type="radio" name="engine" value="cf" class="form-radio" checked />
                    Cloudflare (Schnell & Kostenlos)
                </label>
                <label class="inline-flex items-center gap-2">
                    <input type="radio" name="engine" value="hf" class="form-radio" />
                    Hugging Face (Alternativ)
                </label>
            </div>

            <label class="block mt-4 mb-2 font-semibold">Stile (Mehrfachauswahl)</label>
            <div class="grid grid-cols-2 gap-2">
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Anime / Manga" class="style-checkbox" /> Anime /
                    Manga</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input
                        type="checkbox"
                        value="Hyperrealistic / Photoreal"
                        class="style-checkbox" />
                    Hyperrealistic</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Cyberpunk / Neon" class="style-checkbox" />
                    Cyberpunk</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Vintage Film / 35mm" class="style-checkbox" />
                    Vintage Film</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Surreal / Dreamcore" class="style-checkbox" />
                    Surreal</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Graffiti / Street Art" class="style-checkbox" />
                    Graffiti</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Watercolor / Painterly" class="style-checkbox" />
                    Watercolor</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Concept Art / Matte" class="style-checkbox" />
                    Concept Art</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="3D / Pixar" class="style-checkbox" /> 3D /
                    Pixar</label
                >
                <label class="inline-flex items-center gap-2"
                    ><input type="checkbox" value="Noir / Film Noir" class="style-checkbox" />
                    Noir</label
                >
            </div>

            <div class="flex gap-3 mt-6">
                <button
                    id="generateBtn"
                    class="w-full px-4 py-3 rounded bg-indigo-600 hover:bg-indigo-700 font-semibold">
                    Generate Images
                </button>
            </div>

            <div id="status" class="mt-4 text-sm text-gray-300"></div>

            <div id="results" class="mt-6 grid grid-cols-1 sm:grid-cols-2 gap-4"></div>
        </div>

        <script>
            const generateBtn = document.getElementById("generateBtn");
            const statusEl = document.getElementById("status");
            const resultsEl = document.getElementById("results");
            const promptEl = document.getElementById("prompt");

            function getSelectedStyles() {
                const boxes = Array.from(document.querySelectorAll(".style-checkbox"));
                const chosen = boxes.filter((b) => b.checked).map((b) => b.value);
                return chosen;
            }

            // NEUE Funktion, um die Engine auszulesen
            function getSelectedEngine() {
                const selected = document.querySelector('input[name="engine"]:checked');
                return selected ? selected.value : "cf"; // Standard auf 'cf'
            }

            generateBtn.addEventListener("click", async () => {
                const prompt = promptEl.value.trim();
                const styles = getSelectedStyles();
                const engine = getSelectedEngine(); // Engine-Auswahl holen

                if (!prompt || styles.length === 0) {
                    alert("Bitte Thema und mindestens einen Stil auswählen.");
                    return;
                }

                generateBtn.disabled = true;
                generateBtn.textContent = "Generiere...";
                statusEl.textContent = `Sende ${styles.length} Aufträge...`;
                resultsEl.innerHTML = "";

                for (const style of styles) {
                    // 1. Platzhalter-Karte mit Spinner
                    const placeholderCard = document.createElement("div");
                    placeholderCard.className = "bg-gray-800 p-3 rounded";
                    placeholderCard.innerHTML = `
                <div class="text-sm text-gray-300 mb-2">${style} (${engine.toUpperCase()})</div>
                <div class="flex items-center justify-center h-48">
                    <div class="spinner"></div>
                </div>
                <div class="text-indigo-400 text-sm mt-2">Generiere...</div>
            `;
                    resultsEl.appendChild(placeholderCard);
                    statusEl.textContent = `Generiere Stil: ${style}...`;

                    try {
                        // 2. API-Aufruf (sendet jetzt die 'engine' mit)
                        const response = await fetch("/api/generate", {
                            method: "POST",
                            headers: { "Content-Type": "application/json" },
                            body: JSON.stringify({
                                prompt: prompt,
                                style: style,
                                engine: engine, // HIER wird die Auswahl mitgesendet
                            }),
                        });

                        // ZURÜCK ZUR BLOB-LOGIK (wie vor Imgur)
                        if (!response.ok) {
                            throw new Error(`Server-Fehler: ${response.statusText}`);
                        }

                        // 3. Bild-Blob (statt JSON) empfangen
                        const imageBlob = await response.blob();
                        const imageUrl = URL.createObjectURL(imageBlob);

                        // 4. ERSETZE den Spinner mit dem finalen Bild
                        placeholderCard.innerHTML = `
                    <div class="text-sm text-gray-300 mb-2">${style} (${engine.toUpperCase()})</div>
                    <img src="${imageUrl}" alt="${style}" class="w-full rounded mb-2"/>
                    <a href="${imageUrl}" target="_blank" download="${prompt.replace(
                            /\s+/g,
                            "_"
                        )}-${style}.png" class="text-indigo-400 text-sm">Open / Download</a>
                `;
                    } catch (err) {
                        // 5. Fehler-Karte
                        console.error(err);
                        placeholderCard.innerHTML = `
                    <div class="text-sm text-gray-300 mb-2">${style} (${engine.toUpperCase()})</div>
                    <div class="flex items-center justify-center h-48 bg-gray-700 rounded">
                        <span class="text-red-400 p-4">Fehler: ${err.message}</span>
                    </div>
                    <div class="text-red-400 text-sm mt-2">Generierung fehlgeschlagen</div>
                `;
                    }
                }

                // Fertig
                statusEl.textContent = `Fertig! ${styles.length} Bilder generiert.`;
                generateBtn.disabled = false;
                generateBtn.textContent = "Generate Images";
            });
        </script>
    </body>
</html>
